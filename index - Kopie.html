<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>IPv4</title>
        <style>
            body {
                font-family: sans-serif;
                font-size: 12pt;
            }
            table {
                font-family: monospace;
                border-collapse: collapse;
            }
            tr:nth-child(2n) {
                background-color: #aae;
            }
            tr:nth-child(2n+1) {
                background-color: #ddf;
            }
            td {
                padding: 0.2em;
                border-left: 1px solid black;
                border-right: 1px solid black;
            }
            .rahmen {
                background-color: #22e;
                color: #fff;
                text-align: center;
            }
            .txtrgt {
                text-align: right;
            }
            .txtrgt:hover {
                background-color: black;
                color: white;
            }
        </style>
    </head>
    <body>
        <h3>IP v4 calculator</h3>

        <label for="ip">IP</label>
        <input id="ip" type="text" value="192.168.0.1" onchange="calc()">
        <label for="suffix">Suffix</label>
        <input id="suffix" type="number" value="24" min="0" max="32" onchange="calc()">
        <br>
        <!--<button onclick="calc()">Calculate</button>-->
        <br>
        <table>
            <tr>
                <th></th><th>Address</th><th>Binary</th>
            </tr>
            <tr>
                <td>IP</td><td id="dottetip"></td><td id="ipbin"></td>
            </tr>
            <tr>
                <td>Subnet mask</td><td id="suffixToSubnet"></td><td id="subnetmask"></td>
            </tr>
            <tr>
                <td>Network</td><td id="network"></td><td id="networkbin"></td>
            </tr>
            <tr>
                <td>Host range from</td><td id="numToDottedFrom"></td><td id="ipf"></td>
            </tr>
            <tr>
                <td>Host range to</td><td id="numToDottedTo"></td><td id="ipto"></td>
            </tr>
            <tr>
                <td>Broadcast</td><td id="broadcast"></td><td id="broadcastbin"></td>
            </tr>
            <tr>
                <td>Hosts</td><td id="hosts"></td>
            </tr>
        </table>
        <script>
            calc()
            function calc() {
                const ip = document.getElementById("ip").value
                const suffix = document.getElementById("suffix").value
                const ipAdrRegEx = new RegExp("^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$")

                if (ip === null || suffix === null || ipAdrRegEx.test(ip) === false) {
                    return
                }

                const ipa = strToArray(ip)
                const ipbin = arrayToIP(ipa)//toBin8(ipa[0]) + "." + toBin8(ipa[1]) + "." + toBin8(ipa[2]) + "." + toBin8(ipa[3])
                const sna = strToArray(suffixToSubnet(suffix))
                const subnetmask = toBin8(sna[0]) + "." + toBin8(sna[1]) + "." + toBin8(sna[2]) + "." + toBin8(sna[3])

                const network = (ipa[0] & sna[0]) + "." + (ipa[1] & sna[1]) + "." + (ipa[2] & sna[2]) + "." + (ipa[3] & sna[3])
                const networkbin = toBin8(ipa[0] & sna[0]) + "." + toBin8(ipa[1] & sna[1]) + "." + toBin8(ipa[2] & sna[2]) + "." + toBin8(ipa[3] & sna[3])

                let ipf = (ipa[0] & sna[0]) * 16777216 + (ipa[1] & sna[1]) * 65536 + (ipa[2] & sna[2]) * 256 + (ipa[3] & sna[3])
                /*let ipftemp = ipf + 1
                ipftemp = ipftemp & (Math.pow(2, suffix) - 1)
                ipf = ipf | ipftemp*/
                ipf++

                const broadcast = (ipa[0] | ~sna[0] & 255) + "." + (ipa[1] | ~sna[1] & 255) + "." + (ipa[2] | ~sna[2] & 255) + "." + (ipa[3] | ~sna[3] & 255)
                const broadcastbin = toBin8(ipa[0] | ~sna[0] & 255) + "." + toBin8(ipa[1] | ~sna[1] & 255) + "." + toBin8(ipa[2] | ~sna[2] & 255) + "." + toBin8(ipa[3] | ~sna[3] & 255)

                let ipto = (ipa[0] | ~sna[0] & 255) * 16777216 + (ipa[1] | ~sna[1] & 255) * 65536 + (ipa[2] | ~sna[2] & 255) * 256 + (ipa[3] | ~sna[3] & 255)
                let iptotemp = ipto & (Math.pow(2, 32 - suffix) - 1)
                console.log(iptotemp.toString(2))
                console.log((ipto & (Math.pow(2, suffix) - 1)).toString(2))
                ipto = ipto & (Math.pow(2, suffix) - 1) | (iptotemp - 1)

                let hosts = Math.pow(2, 32-suffix)-2
                hosts = (hosts < 0) ? 0 : hosts

                document.getElementById("dottetip").innerHTML = ip
                document.getElementById("ipbin").innerHTML = ipbin
                document.getElementById("suffixToSubnet").innerHTML = suffixToSubnet(suffix)
                document.getElementById("subnetmask").innerHTML = subnetmask
                document.getElementById("network").innerHTML = network
                document.getElementById("networkbin").innerHTML = networkbin
                document.getElementById("numToDottedFrom").innerHTML = numToDotted(ipf)
                document.getElementById("ipf").innerHTML = arrayToIP(strToArray(numToDotted(ipf)))
                document.getElementById("numToDottedTo").innerHTML = numToDotted(ipto)
                document.getElementById("ipto").innerHTML = arrayToIP(strToArray(numToDotted(ipto)))
                document.getElementById("broadcast").innerHTML = broadcast
                document.getElementById("broadcastbin").innerHTML = broadcastbin
                document.getElementById("hosts").innerHTML = hosts
            }
            function numToDotted(num) {
                return ((num >> 24) & 255) + "." + ((num >> 16) & 255) + "." + ((num >> 8) & 255) + "." + (num & 255)
            }
            function dottedToNum(dotted) {
                let result = 0
                for (let i = 0; i < 4; i++) {
                    if (dotted.indexOf(".") !== -1) {
                        result = result * 256 + Number(dotted.substring(0, dotted.indexOf(".")))
                        dotted = dotted.substring(dotted.indexOf(".") + 1)
                    } else {
                        result = result * 256 + Number(dotted)
                    }
                }
                return result
            }
            function arrayToIP(a) {
                return toBin8(a[0]) + "." + toBin8(a[1]) + "." + toBin8(a[2]) + "." + toBin8(a[3])
            }
            function strToArray(ip) {
                const ipadrreg = new RegExp("^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$")
                let iparray = []
                if (ipadrreg.test(ip)) {
                    iparray = []
                    for (let i = 0; i < 4; i++) {
                        if (ip.indexOf(".") !== -1) {
                            iparray[i] = ip.substring(0, ip.indexOf("."))
                            ip = ip.substring(ip.indexOf(".") + 1)
                        } else {
                            iparray[i] = ip
                        }

                    }

                }
                return iparray
            }
            function suffixToSubnet(suffix) {
                let result = ""
                for (let i = 0; i < 4; i++) {
                    if (suffix >= 8) {
                        result += "255."
                        suffix -= 8
                    } else if (suffix === 0) {
                        result += "0."
                    } else {
                        let num = 0
                        for (let i = 0; i < 8; i++) {
                            if (suffix > 0) {
                                num = num * 2 + 1
                                suffix--
                            } else {
                                num = num * 2
                            }
                        }
                        result += num + "."
                    }
                }
                return result.substring(0, result.length - 1)
            }
            function toBin(num) {
                num = Number(num)
                return ("0000"+num.toString(2)).substr(-4)
            }
            function toBin8(num) {
                num = Number(num)
                return ("00000000"+num.toString(2)).substr(-8)
            }
            function toHex(num) {
                return num.toString(16).toUpperCase()
            }
            function toHex8(num) {
                return ("00"+num.toString(16)).substr(-2).toUpperCase()
            }
        </script>
    </body>
</html>
